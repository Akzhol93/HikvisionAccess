<!-- your_template.html -->
{% extends 'base.html' %}

{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">

<div class="container">
    <h1>Организации и их устройства</h1>
    <ul id="organization-list"></ul>
</div>

<script>
    document.cookie = "access=test_token; path=/";
    // Retrieve the cookie
    console.log(document.cookie);
    function getToken() {
    // Function to get the JWT token from cookies
    const cookies = document.cookie.split('; ');
    console.log('ff',cookies)
    const tokenCookie = cookies.find(row => row.startsWith('access='));
    console.log('ff',tokenCookie)

    if (tokenCookie) {
        return tokenCookie.split('=')[1];
    } else {
        console.error('JWT token not found in cookies.');
        return null; // Return null if the token is not found
    }
}

    // Функция для переключения состояния плана
    function togglePlan(deviceId, planId, currentState) {
        const newState = !currentState;
        const token = getToken();

        if (!token) {
        alert('JWT token is missing or invalid.');
        return; // Exit the function if no token is available
    }
        
        fetch(`/devices/${deviceId}/weekplan/${planId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`, // Include the token here
        
            },
            body: JSON.stringify({ enable: newState })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновление состояния кнопки
                const button = document.querySelector(`#toggle-button-${planId}`);
                button.classList.toggle('enabled', newState);
                button.classList.toggle('disabled', !newState);
                button.dataset.state = newState;
            } else {
                alert('Failed to update the plan');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // --------------------------------------------------------------------------------------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем и парсим JSON данные
        var organizations = JSON.parse('{{ organization_list|escapejs }}');
        var listContainer = document.getElementById('organization-list');

        organizations.forEach(function(org) {
            var orgItem = document.createElement('li');
            orgItem.textContent = `${org.organization_name} (BIN: ${org.organization_bin})`;

            // Создаем список устройств для организации
            var devicesList = document.createElement('ul');
            devicesList.className = 'nested';
            org.devices.forEach(function(device) {
                var deviceItem = document.createElement('li');
                deviceItem.textContent = `${device.device_name} (IP: ${device.device_ip}, Port: ${device.device_port})`;

                // Создаем список расписаний для устройства
                var scheduleList = document.createElement('ul');
                scheduleList.className = 'nested';
                Object.values(device.schedules).forEach(function(schedule) {
                    var scheduleItem = document.createElement('li');
                    var scheduleContent = `<strong>${schedule.template.templateName}</strong><br>`;

                    if (schedule.week_plan.enable) {
                        scheduleContent += `<div style="display: flex; flex-wrap: wrap;">`;
                        // Собираем дни недели и группируем по ним
                        var weekPlans = schedule.week_plan.WeekPlanCfg.reduce((acc, plan) => {
                            if (!acc[plan.week]) {
                                acc[plan.week] = [];
                            }
                            acc[plan.week].push(plan);
                            return acc;
                        }, {});

                        // Отображаем дни недели как вертикальные блоки
                        for (const [weekDay, plans] of Object.entries(weekPlans)) {
                            scheduleContent += `<div class="week-block"><h3>${weekDay}</h3><ul>`;
                            plans.forEach(function(plan) {
                                scheduleContent += `<li>
                                    <span>${plan.TimeSegment.beginTime} - ${plan.TimeSegment.endTime}</span>
                                    <button 
                                        id="toggle-button-${plan.id}" 
                                        class="toggle-button ${plan.enable ? 'enabled' : 'disabled'}" 
                                        data-state="${plan.enable}"
                                        onclick="togglePlan(${device.device_id}, ${plan.id}, ${plan.enable})">
                                    </button>
                                </li>`;
                            });
                            scheduleContent += `</ul></div>`;
                        }
                        scheduleContent += `</div>`;
                    } else {
                        scheduleContent += `<em>Неактивен</em>`;
                    }

                    scheduleItem.innerHTML = scheduleContent;
                    scheduleList.appendChild(scheduleItem);
                });

                // Добавляем список расписаний к элементу устройства
                deviceItem.appendChild(scheduleList);
                devicesList.appendChild(deviceItem);
            });

            // Добавляем список устройств к элементу организации
            orgItem.appendChild(devicesList);
            listContainer.appendChild(orgItem);
        });
    });
    </script>

{% endblock %}
